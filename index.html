<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ–°å¼-è¡ŒéŠ·åˆä½œåŒæ„æ›¸ï½œA4 v16 (Mobile Safe + é˜²æ»‘å‹•ç°½å)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root { --a4-w: 210mm; --a4-h: 297mm; --pad: 14mm; }
  html, body { background:#e5e7eb; margin:0; }
  body { font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; }
  .sheet { width: var(--a4-w); min-height: var(--a4-h); margin: 12px auto 72px; background:#fff; color:#111827; box-shadow:0 4px 20px rgba(0,0,0,.08); }
  .inner { padding: var(--pad); box-sizing:border-box; }
  h1 { text-align:center; font-size:18pt; margin:0 0 8mm; letter-spacing:.5px; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; column-gap:8mm; }
  label { font-weight:600; font-size:11pt; display:block; margin:0 0 2mm; }
  input[type=text] { width:100%; border:1px solid #9ca3af; border-radius:6px; padding:10px 12px; font-size:11pt; line-height:1.6; -webkit-appearance:none; }
  .row { margin: 0 0 6mm; }
  .section { border:1px solid #e5e7eb; border-radius:6px; padding:6mm; margin: 0 0 6mm; }
  .muted { color:#4b5563; font-size:10.5pt; line-height:1.7; }
  ol { margin: 2mm 0 0 5mm; }
  li { margin: 1mm 0; }
  .agree-line { display:flex; align-items:flex-start; gap:4mm; font-size:11pt; margin: 4mm 0; }
  .agree-line input { transform: translateY(2px); }
  .sig-box { border:1px dashed #6b7280; border-radius:6px; padding:3mm; margin-top:6mm; }
  /* é˜²æ­¢ç°½åæ™‚æ»‘å‹•ï¼štouch-action:none ä»ä¸è¶³ï¼Œæœƒåœ¨ JS è£œä¸Š preventDefault */
  #signature { width:100%; height:60mm; background:#fff; border-radius:4px; display:block; touch-action:none; }
  .footer-note { font-size:9.5pt; color:#6b7280; margin-top:2mm; }
  .btn { border:1px solid #cbd5e1; background:#111827; color:#fff; padding:9px 14px; font-size:12pt; border-radius:6px; cursor:pointer; }
  .btn.secondary { background:#fff; color:#111827; }
  .fixedbar { position:fixed; left:0; right:0; bottom:0; background:#111827; padding:10px 14px; display:flex; justify-content:center; gap:10px; z-index:50; }
  .fixedbar .btn { background:#fff; color:#111827; }
  .hidden { position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; overflow:hidden; }
  .print-field { border:1px solid #9ca3af; border-radius:6px; padding:10px 12px; font-size:11pt; line-height:1.6; white-space:pre-wrap; min-height:18px; }
  @media (max-width: 768px) { .sheet { width:100%; min-height:auto; } .grid-2 { grid-template-columns:1fr; row-gap:6mm; } h1 { font-size:16pt; } input[type=text]{font-size:12pt;} #signature { height:40mm; } }
  /* ç°½åä¸­é–ä½æ•´é æ»¾å‹• */
  .lock-scroll { overflow:hidden; touch-action:none; overscroll-behavior:contain; }
</style>
</head>
<body>

<div class="sheet" id="a4">
  <div class="inner">
    <h1>æ–°å¼-è¡ŒéŠ·åˆä½œåŒæ„æ›¸</h1>

    <div class="grid-2 row">
      <div><label>ç”²æ–¹ï¼ˆåˆä½œäººï¼‰</label><input id="f_name" type="text" placeholder="è«‹è¼¸å…¥å§“å"></div>
      <div><label>èº«åˆ†è­‰å­—è™Ÿ</label><input id="f_id" type="text" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ"></div>
    </div>

    <div class="grid-2 row">
      <div><label>è¯çµ¡é›»è©±</label><input id="f_phone" type="text" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±"></div>
      <div><label>è¯çµ¡åœ°å€</label><input id="f_addr" type="text" placeholder="è«‹è¼¸å…¥è¯çµ¡åœ°å€"></div>
    </div>

    <div class="row"><label>ä¹™æ–¹</label><div>å½­è³¢ç¦®çš®è†šç§‘è¨ºæ‰€ï¼åœ‹éš›çš®è†šç§‘è¨ºæ‰€</div></div>
    <div class="row"><label>ä»Šæ—¥ç™‚ç¨‹</label><input id="f_treatment" type="text" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ç™‚ç¨‹"></div>

    <div class="section muted">
      <div style="font-weight:700">ä¸€ã€åˆä½œå…§å®¹</div>
      <ol>
        <li>ä¹™æ–¹åŒæ„æä¾›ç”²æ–¹å…è²»æˆ–å„ªæƒ ä¹‹å¾®æ•´å½¢æ³¨å°„ã€é›·å°„æˆ–å…¶ä»–é†«å­¸ç¾å®¹ç™‚ç¨‹ã€‚</li>
        <li>ç”²æ–¹åŒæ„æˆæ¬Šä¹™æ–¹æ–¼å…¬é–‹ç™¼è¡¨æˆ–åª’é«”ç›¸é—œåˆŠç‰©ä¸­ä½¿ç”¨ç”²æ–¹ä¹‹æ²»ç™‚å‰å¾Œç…§ç‰‡åŠå½±ç‰‡ï¼Œä½¿ç”¨ç¯„åœåŒ…å«ï¼šå¹³é¢æ–°èã€é›»å­åª’é«”ã€é†«å­¸æ–‡ç»ã€è¡›æ•™æ•™æåŠè¡ŒéŠ·æ–‡å®£ï¼ˆå«æµ·å ±ã€DMã€VCDã€å®˜ç¶²ã€ç¤¾ç¾¤å¹³å°ï¼‰ï¼Œä¸¦æ–¼åˆç†ç¯„åœå…§ä½œç›¸é—œç”¨é€”ã€‚</li>
      </ol>
      <div style="font-weight:700; margin-top:3mm;">äºŒã€ç”²æ–¹ç¾©å‹™</div>
      <ol>
        <li>ç”²æ–¹åŒæ„æ–¼ç™‚ç¨‹å¾Œé…åˆä¹™æ–¹ä¹‹å›è¨ºåŠå½±åƒæ‹æ”ï¼Œä»¥è¿½è¹¤æ²»ç™‚æ•ˆæœï¼Œä¸¦æˆæ¬Šä¹™æ–¹ä½¿ç”¨è©²å½±åƒæ–¼ä¸Šè¿°ç¯„åœã€‚æ‹æ”æ™‚é–“ï¼šè¡“å¾Œ 1 é€±ã€1 å€‹æœˆã€2 å€‹æœˆã€3 å€‹æœˆã€6 å€‹æœˆã€12 å€‹æœˆã€‚</li>
        <li>è‹¥ç”²æ–¹æœªä¾ç´„é…åˆå›è¨ºæ‹æ”æˆ–é•åæœ¬åŒæ„æ›¸ç´„å®šï¼Œç”²æ–¹æ‡‰è£œå„Ÿä¹™æ–¹æ‰€æä¾›ç™‚ç¨‹ä¹‹åŸåƒ¹å…¨é¡ã€‚</li>
      </ol>
      <p>æœ¬åŒæ„æ›¸è‡ªç°½ç½²æ—¥èµ·ç”Ÿæ•ˆï¼Œæ•ˆåŠ›æŒçºŒè‡³åˆä½œå½±åƒä½¿ç”¨éœ€æ±‚çµ‚æ­¢ä¹‹æ—¥æ­¢ã€‚ç”²æ–¹å·²å……åˆ†é–±è®€ä¸¦ç†è§£æœ¬åŒæ„æ›¸ä¹‹å…§å®¹ï¼Œä¸¦åŒæ„éµå®ˆå…¶è¦ç¯„ã€‚</p>
    </div>

    <div class="agree-line"><input id="f_agree" type="checkbox"><label for="f_agree">æˆ‘å·²å®Œæ•´é–±è®€ä¸¦åŒæ„ä¸Šè¿°åˆä½œå…§å®¹èˆ‡ç”²æ–¹ç¾©å‹™ã€‚</label></div>

    <div class="row sig-box">
      <label style="margin:0 0 2mm;">è“‹ç« ï¼ˆç°½åï¼‰</label>
      <canvas id="signature"></canvas>
      <div style="margin-top:3mm;"><button class="btn secondary" id="btnClear">æ¸…é™¤ç°½å</button></div>
    </div>

    <div class="row"><label>æ—¥æœŸ</label><input id="f_date" type="text" placeholder="è‡ªå‹•å¸¶å…¥ï¼ˆyyyyå¹´mæœˆdæ—¥ï¼‰"></div>
    <div class="footer-note">åŒ¯å‡º PDF å¾Œï¼Œæ¬„ä½èˆ‡ç°½åå°‡å›ºå®šç‚ºå½±åƒï¼Œç„¡æ³•å†ç·¨è¼¯ã€‚</div>
  </div>
</div>

<div class="fixedbar">
  <button class="btn secondary" id="btnValidate">æª¢æŸ¥å¿…å¡«</button>
  <button class="btn" id="btnExport">åŒ¯å‡ºæ•´é  PDF</button>
</div>

<div id="hiddenArea" class="hidden" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
(function(){
  function zhDate(d){ return d.getFullYear() + "å¹´" + (d.getMonth()+1) + "æœˆ" + d.getDate() + "æ—¥"; }
  const dateInput = document.getElementById('f_date');
  dateInput.value = zhDate(new Date());

  // Signature pad
  const canvas = document.getElementById('signature');
  const pad = new window.SignaturePad(canvas, { minWidth:1, maxWidth:2 });
  function resizeCanvas(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const w = canvas.clientWidth, h = canvas.clientHeight || 240;
    canvas.width = w * ratio; canvas.height = h * ratio;
    canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
    canvas.getContext('2d').scale(ratio, ratio);
    pad.clear();
  }
  window.addEventListener('resize', resizeCanvas);
  setTimeout(resizeCanvas, 0);
  document.getElementById('btnClear').addEventListener('click', ()=> pad.clear());

  // ğŸš« é˜²æ»‘å‹•ï¼šç°½åæ™‚æš«æ™‚é–ä½æ•´é æ²å‹•
  let drawing = false;
  const lockScroll = (lock)=>{
    if (lock) { document.body.classList.add('lock-scroll'); }
    else { document.body.classList.remove('lock-scroll'); }
  };
  const start = (e)=>{ drawing = true; lockScroll(true); e.preventDefault(); };
  const move  = (e)=>{ if (drawing) e.preventDefault(); };
  const end   = (e)=>{ drawing = false; lockScroll(false); e.preventDefault(); };

  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end,   {passive:false});
  canvas.addEventListener('touchcancel',end,   {passive:false});
  // å…¼å®¹ä¸€äº› Android è£ç½®ï¼šåœ¨ç•«å¸ƒä¸Šæ»‘å‹•ä¹Ÿé˜»æ­¢æ»¾å‹•
  canvas.addEventListener('gesturestart', start, {passive:false});

  function validate(){
    const req = [
      ['f_name','è«‹å¡«å¯«ã€Œç”²æ–¹ï¼ˆåˆä½œäººï¼‰ã€'],
      ['f_id','è«‹å¡«å¯«ã€Œèº«åˆ†è­‰å­—è™Ÿã€'],
      ['f_phone','è«‹å¡«å¯«ã€Œè¯çµ¡é›»è©±ã€'],
      ['f_addr','è«‹å¡«å¯«ã€Œè¯çµ¡åœ°å€ã€'],
      ['f_treatment','è«‹å¡«å¯«ã€Œä»Šæ—¥ç™‚ç¨‹ã€']
    ];
    for(const [id,msg] of req){
      const el = document.getElementById(id);
      if(!el.value.trim()){ alert(msg); el.focus(); return false; }
    }
    if(!document.getElementById('f_agree').checked){ alert('è«‹å‹¾é¸åŒæ„æ¢æ¬¾'); return false; }
    if(pad.isEmpty()){ alert('è«‹å®Œæˆç°½å'); return false; }
    return true;
  }
  document.getElementById('btnValidate').addEventListener('click', validate);

  function isMobile(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

  function buildPrintClone(){
    const clone = document.getElementById('a4').cloneNode(true);
    const fixed = clone.querySelector('.fixedbar'); if (fixed) fixed.remove();
    clone.querySelectorAll('input[type="text"]').forEach(inp => {
      const box = document.createElement('div');
      box.className = 'print-field';
      box.textContent = inp.value || '';
      inp.parentNode.replaceChild(box, inp);
    });
    const sigCanvas = document.getElementById('signature');
    const sigImg = new Image();
    sigImg.src = sigCanvas.toDataURL('image/png');
    clone.querySelector('#signature').replaceWith(sigImg);
    return clone;
  }

  async function exportPDF(){
    if(!validate()) return;
    dateInput.value = zhDate(new Date());

    const mount = document.getElementById('hiddenArea');
    mount.innerHTML = '';
    const printNode = buildPrintClone();
    mount.appendChild(printNode);

    const el = mount.querySelector('#a4');

    const baseScale = isMobile() ? 2.0 : 3.0;
    const rect = el.getBoundingClientRect();
    const targetW = rect.width * baseScale;
    const targetH = rect.height * baseScale;
    const maxPixels = isMobile() ? 12_000_000 : 20_000_000; // é™åˆ¶ç¸½åƒç´ 
    const factor = Math.min(1, Math.sqrt(maxPixels / (targetW * targetH)));
    const scale = Math.max(1.5, baseScale * factor); // æ‰‹æ©Ÿè‡³å°‘ 1.5x

    const c = await window.html2canvas(el, { scale, useCORS: true, scrollY: 0, letterRendering: true, backgroundColor: '#ffffff' });

    const imgData = c.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');

    // ç­‰æ¯”ä¾‹ç½®ä¸­
    const pageW = 210, pageH = 297;
    const imgWpx = c.width, imgHpx = c.height;
    const imgRatio = imgWpx / imgHpx, pageRatio = pageW / pageH;
    let renderW, renderH;
    if (imgRatio > pageRatio) { renderW = pageW; renderH = renderW / imgRatio; }
    else { renderH = pageH; renderW = renderH * imgRatio; }
    const offsetX = (pageW - renderW) / 2, offsetY = (pageH - renderH) / 2;
    doc.addImage(imgData, 'JPEG', offsetX, offsetY, renderW, renderH);

    const name = (document.getElementById('f_name').value || 'æœªå¡«å§“å').trim();
    const t = new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isIOS) {
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `åŒæ„æ›¸_${y}-${m}-${d}_${name}.pdf`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
    } else {
      doc.save(`åŒæ„æ›¸_${y}-${m}-${d}_${name}.pdf`);
    }
  }

  document.getElementById('btnExport').addEventListener('click', exportPDF);
})(); 
</script>
</body>
</html>